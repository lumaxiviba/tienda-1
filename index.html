<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cat√°logo | Mi Tienda</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Times New Roman', serif;
      background-color: #f2f2f2;
      color: #000;
    }
    .navbar {
      background-color: #000 !important;
    }
    .navbar-brand, .nav-link, .btn-outline-light {
      color: #fff !important;
    }
    .card {
      border-radius: 15px;
    }
    .admin-only {
      display: none; /* se muestra s√≥lo si isAdmin = true */
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container d-flex justify-content-between">
      <a class="navbar-brand" href="index.html">üõçÔ∏è Mi Tienda</a>
      <div class="d-flex gap-2">
        <div id="adminBtns" class="btn-group admin-only">
          <a href="categorias.html" class="btn btn-outline-light btn-sm">+ Categor√≠a</a>
          <a href="productos.html" class="btn btn-outline-light btn-sm">+ Producto</a>
          <a href="imagenes.html" class="btn btn-outline-light btn-sm">+ Imagen</a>
        </div>
        <a id="btnLogin" href="login.html" class="btn btn-outline-light btn-sm">Login</a>
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- T√≠tulo con stickers -->
    <h1 class="text-center my-4 titulo-catalogo fw-bold">
      <span class="sticker">‚ú®</span> Cat√°logo <span class="sticker">üõí</span>
    </h1>

    <!-- Buscador y filtro -->
    <div class="row mb-4 justify-content-center">
      <div class="col-md-4 mb-2">
        <div class="input-group shadow-sm">
          <span class="input-group-text bg-dark text-white">üîç</span>
          <input id="buscador" type="text" class="form-control" placeholder="Buscar por nombre o categor√≠a...">
        </div>
      </div>
      <div class="col-md-3">
        <select id="filtroCategoria" class="form-select shadow-sm"></select>
      </div>
    </div>

    <!-- Productos -->
    <div id="productos" class="row row-cols-1 row-cols-md-3 g-4"></div>
  </div>

  <!-- Modal de edici√≥n (solo la usa admin; el HTML puede permanecer siempre) -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">‚úèÔ∏è Editar Producto</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formEditar">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input id="editNombre" type="text" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Precio (S/)</label>
              <input id="editPrecio" type="number" step="0.01" class="form-control" required>
            </div>
            <input type="hidden" id="editId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancelar</button>
          <button type="button" class="btn btn-success" onclick="guardarEdicion()"> Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const API = window.location.origin;

  let listaProductos = [];
  let listaCategorias = [];

  // Estado de autenticaci√≥n (JWT + rol)
  const token = localStorage.getItem("token");
  const rol = localStorage.getItem("rol");
  const isAdmin = Boolean(token && rol === "admin");

  // Navbar: Login / Logout y botones admin
  const btnLogin = document.getElementById("btnLogin");
  const adminGroups = document.querySelectorAll(".admin-only");

  if (isAdmin) {
    // Mostrar botones admin
    adminGroups.forEach(el => el.style.display = "inline-block");
    // Cambiar a Logout
    btnLogin.textContent = "Logout";
    btnLogin.href = "#";
    btnLogin.onclick = (e) => {
      e.preventDefault();
      localStorage.removeItem("token");
      localStorage.removeItem("rol");
      location.reload(); // vuelve a vista cliente
    };
  } else {
    // Ocultar botones admin, asegurar Login
    adminGroups.forEach(el => el.style.display = "none");
    btnLogin.textContent = "Login";
    btnLogin.href = "login.html";
    btnLogin.onclick = null;
  }

  // üöÄ Cargar productos y categor√≠as (p√∫blico, sin token)
  async function cargarDatos() {
    try {
      const resProd = await fetch(`${API}/productos`);
      listaProductos = await resProd.json();

      const resCat = await fetch(`${API}/categorias`);
      listaCategorias = await resCat.json();

      renderCategorias();
      renderProductos(listaProductos);
    } catch (error) {
      console.error("‚ùå Error cargando datos:", error);
    }
  }

  // üöÄ Renderizar categor√≠as
  function renderCategorias() {
    const select = document.getElementById("filtroCategoria");
    select.innerHTML = `<option value="">Todas las categor√≠as</option>`;
    listaCategorias.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nombre;
      opt.textContent = c.nombre;
      select.appendChild(opt);
    });
  }

  // üöÄ Renderizar productos
  async function renderProductos(productos) {
    const contenedor = document.getElementById("productos");
    contenedor.innerHTML = "";

    if (!productos || productos.length === 0) {
      contenedor.innerHTML = `<div class="col-12 text-center">No hay productos disponibles</div>`;
      return;
    }

    for (const p of productos) {
      let imagenUrl = "https://via.placeholder.com/300x200?text=Sin+Imagen";
      try {
        const resImg = await fetch(`${API}/imagenes/${p.id}`); // p√∫blico
        const imagenes = await resImg.json();
        if (Array.isArray(imagenes) && imagenes.length > 0) imagenUrl = imagenes[0].url;
      } catch (e) {
        console.error("Error cargando im√°genes:", e);
      }

      const card = document.createElement("div");
      card.className = "col";
      card.innerHTML = `
        <div class="card h-100 shadow-sm p-2">
          <a href="detalle.html?id=${p.id}">
            <img src="${imagenUrl}" class="card-img-top" alt="${p.nombre}">
          </a>
          <div class="card-body text-center">
            <h5 class="card-title">
              <a href="detalle.html?id=${p.id}" class="text-decoration-none text-dark">${p.nombre}</a>
            </h5>
            <p class="text-muted mb-1">Categor√≠a: ${p.categoria || "Sin categor√≠a"}</p>
            <p class="fw-bold">S/ ${Number(p.precio).toFixed(2)}</p>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
              <a href="detalle.html?id=${p.id}" class="btn btn-info btn-sm">Ver detalle</a>
              ${isAdmin ? `
                <button class="btn btn-warning btn-sm" onclick="abrirEditar(${p.id})">Actualizar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${p.id})">Eliminar</button>
              ` : ""}
            </div>
          </div>
        </div>
      `;
      contenedor.appendChild(card);
    }
  }

  // busqueda
  document.getElementById("buscador").addEventListener("input", aplicarFiltros);
  document.getElementById("filtroCategoria").addEventListener("change", aplicarFiltros);

  function aplicarFiltros() {
    const texto = document.getElementById("buscador").value.toLowerCase();
    const categoriaSel = document.getElementById("filtroCategoria").value;

    const filtrados = (listaProductos || []).filter(p => {
      const coincideTexto =
        (p.nombre || "").toLowerCase().includes(texto) ||
        (p.categoria && p.categoria.toLowerCase().includes(texto));
      const coincideCategoria = categoriaSel === "" || p.categoria === categoriaSel;
      return coincideTexto && coincideCategoria;
    });

    renderProductos(filtrados);
  }

  // üöÄ Funciones admin (protegidas con token)
  async function eliminarProducto(id) {
    if (!isAdmin) return; // seguridad extra en cliente
    if (!confirm("¬øEliminar este producto?")) return;
    try {
      await fetch(`${API}/productos/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      cargarDatos();
    } catch (e) {
      console.error("Error eliminando producto:", e);
    }
  }

  // Abrir modal de actualizar
  function abrirEditar(id) {
    if (!isAdmin) return;
    const producto = listaProductos.find(p => p.id === id);
    if (!producto) return;
    document.getElementById("editId").value = producto.id;
    document.getElementById("editNombre").value = producto.nombre;
    document.getElementById("editPrecio").value = producto.precio;

    const modal = new bootstrap.Modal(document.getElementById("modalEditar"));
    modal.show();
  }

  // Guardar cambios desde modal
  async function guardarEdicion() {
    if (!isAdmin) return;
    const id = document.getElementById("editId").value;
    const nuevoNombre = document.getElementById("editNombre").value.trim();
    const nuevoPrecio = document.getElementById("editPrecio").value;

    try {
      await fetch(`${API}/productos/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ nombre: nuevoNombre, precio: Number(nuevoPrecio) })
      });
      bootstrap.Modal.getInstance(document.getElementById("modalEditar")).hide();
      cargarDatos();
    } catch (err) {
      console.error("‚ùå Error actualizando producto:", err);
    }
  }

  // üöÄ Iniciar
  cargarDatos();
</script>

</body>
</html>
